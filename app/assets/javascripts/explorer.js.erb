var Explorer = (function() {
  var server = '<%= SERVER %>';
  var data, place;
  var li_template, path_template;

  var debug = function() {
    debugger;
  };

  var init = function() {
    place = $('.explorer');
    li_template = $('#li-template').html();
    path_template = $('#path-template').html();

    repaint(1);
    bindArrows();
  };

  var repaint = function(item_id) {
    place.html('');
    getData(item_id).then(function(_data) {
      data = _data;
      recursivePopulate(data.structure);
    });
  };

  var bindArrows = function() {
    $(document).on('click', '.arrow a', toggle);
  };

  var toggle = function(event) {
    event.preventDefault()

    var li = $(this).closest('li');
    var level = getLevel(li);

    if (level != 1) {
      repaint(li.data('item_id'));
    }

    var next_all = li.nextAll();

    _.each(next_all, function(next_li) {
      var next_level = getLevel(next_li);
      if (next_level > level) {
        $(next_li).toggle();
      } else {
        return false;
      }
    });
  };

  var getLevel = function(li) {
    return $(li).attr('class').match(/level-\d/)[0].replace(/^\D+/g, '');
  };

  var app***REMOVED***Item = function(item_id, level) {
    var item = data.items[item_id];

    var klass = 'level-' + level;
    if (parseInt(item_id) == data.center) {
      klass += ' center';
    }

    $(_.template(li_template, {
          item_id: item.id,
          title: item.title,
          show_url: item.show_url,
          klass: klass
    })).app***REMOVED***To(place).slideDown('fast');

    var paths_place = place.find('li:last-child .paths');

    _.each(item.paths, function(path_id) {
      var path = data.paths[path_id];

      paths_place.app***REMOVED***(_.template(path_template, {
        title: path.title
      }));
    });
  };

  var recursivePopulate = function(structure, level) {
    level = level || 0;

    _.each(structure, function(branch) {
      _.each(branch, function(children, item_id) {
        app***REMOVED***Item(item_id, level);
        recursivePopulate(children, level+1);
      });

    });
  };

  var getData = function(item_id) {
    return $.ajax({
      type: 'GET',
      url: server + '/explore',
      xhrFields: {
        withCredentials: true
      },
      data: {
        item_id: item_id
      }
    });
  };

  return {
    init: init,
    _private: eval(private(arguments))
  };
})();

jQuery(function($) {
  Explorer.init();
});
