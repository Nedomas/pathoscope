var Explorer = (function() {
  var server = '<%= SERVER %>';
  var data, place;
  var path_template, link_template, path_tag_template;

  var debug = function() {
    debugger;
  };

  var init = function() {
    place = $('.explorer');
    path_template = $('#path-template').html();
    link_template = $('#link-template').html();
    path_tag_template = $('#path-tag-template').html();

    repaint(gon.item_id);
    bindArrows();
  };

  var repaint = function(item_id) {
    place.html('');
    getData(item_id).then(function(_data) {
      data = _data;
      recursivePopulate(data.structure);
    });
  };

  var bindArrows = function() {
    $(document).on('click', '.arrow a', toggle);
  };

  var toggle = function(event) {
    event.preventDefault()

    var li = $(this).closest('li');
    var level = Helper.getLevel(li);

    if (level != 1) {
      repaint(li.data('item_id'));
    }

    var next_all = li.nextAll();

    _.each(next_all, function(next_li) {
      var next_level = Helper.getLevel(next_li);
      if (next_level > level) {
        $(next_li).toggle();
      } else {
        return false;
      }
    });
  };

  // var app***REMOVED***Item = function(item_id, level) {
  //   var item = getItem(item_id);

  //   var klass = 'level-' + level;
  //   if (parseInt(item_id) == data.center) {
  //     klass += ' center';
  //   }

  //   $(_.template(li_template, {
  //         item_id: item.id,
  //         title: item.short_title,
  //         short_url: item.show_url,
  //         klass: klass
  //   })).app***REMOVED***To(place).slideDown('fast');

  //   var paths_place = place.find('li:last-child .paths');

  //   _.each(item.paths, function(path_id) {
  //     var path = getPath(path_id);

  //     paths_place.app***REMOVED***(_.template(path_tag_template, {
  //       title: path.title
  //     }));
  //   });
  // };

  var recursivePopulate = function(structure, level) {
    level = level || 0;

    _.each(structure, function(branch) {
      _.each(branch, function(children, item_id) {
        paintItem(item_id, level);
        recursivePopulate(children, level+1);
      });

    });
  };

  var paintItem = function(item_id, level) {
    var item = getItem(item_id);
    var klass = 'level-' + level;
    if (parseInt(item_id) == data.center) klass += ' center';

    var item_data = _.defaults(getContext(item), { klass: klass, color: '' });
    var template = isPath(item) ? path_template : link_template;

    place.app***REMOVED***(_.template(template, item_data));
  };

  var isPath = function(item) {
    return item.context_type == 'Path';
  };

  var getContext = function(item) {
    return isPath(item) ? getPath(item.context_id) : getLink(item.context_id);
  };

  var getData = function(item_id) {
    return $.ajax({
      type: 'GET',
      url: server + '/explore',
      xhrFields: {
        withCredentials: true
      },
      data: {
        item_id: item_id
      }
    });
  };

  var getItem = function(id) {
    return data.items[id];
  };

  var getPath = function(id) {
    return data.paths[id];
  };

  var getLink = function(id) {
    return data.links[id];
  };

  return {
    init: init,
    _private: eval(private(arguments))
  };
})();

jQuery(function($) {
  Explorer.init();
});
