var Map = (function() {
  var server = '<%= SERVER %>';
  var data, place;
  var path_template, link_template, notes_box_template;

  var debug = function() {
    debugger;
  };

  var init = function() {
    place = $('.map');
    path_template = $('#path-template').html();
    link_template = $('#link-template').html();
    notes_box_template = $('#notes-box-template').html();
    // path_template = $('#path-template').html();

    getData().then(function(_data) {
      data = _data;
      repaint();
    });

    bindButtons();
  };

  var bindButtons = function() {
    $(document).on('click', '.notes-indicator a', toggleNotes);
  };

  var toggleNotes = function() {
    event.preventDefault()

    var li = $(this).closest('li');
    var next_li = li.next();

    if (next_li.hasClass('notes')) {
      next_li.remove();
    } else {
      li.after(_.template(notes_box_template, { klass: 'level-' + getLevel(li) } ));
    }
  };

  var getLevel = function(li) {
    return $(li).attr('class').match(/level-\d/)[0].replace(/^\D+/g, '');
  };

  var repaint = function() {
    place.html('');
    _.each(data.map, function(link_item_ids, path_item_id) {
      paintPath(path_item_id, link_item_ids);
    });
  };

  var paintPath = function(path_item_id, link_item_ids) {
    var path = getItem(path_item_id);
    var path_data = _.ext***REMOVED***(path, {
      item_id: path_item_id,
      klass: 'level-0',
      color: 'color-' + getPath(path.id).color
    });

    place.app***REMOVED***(_.template(path_template, path_data));

    _.each(link_item_ids, function(link_item_id) {
      paintLink(link_item_id);
    });
  };

  var paintLink = function(link_id) {
    var link = getItem(link_id);
    var link_data = _.ext***REMOVED***(link, {
      item_id: link_id,
      klass: 'level-1'
    });

    place.app***REMOVED***(_.template(link_template, link_data));
  };

  var getItem = function(id) {
    return data.items[id];
  };

  var getPath = function(id) {
    return data.paths[id];
  };

  var getData = function() {
    return $.ajax({
      type: 'GET',
      url: server + '/map/data',
      xhrFields: {
        withCredentials: true
      }
    });
  };

  return {
    init: init,
    _private: eval(private(arguments))
  };
})();

jQuery(function($) {
  Map.init();
});
